var AP=AP||{};AP.Array="function"==typeof Float32Array?Float32Array:Array,AP.Math={ETQ:Math.PI/360,DTR:Math.PI/180,RTD:180/Math.PI,degreesToRadians:function(a){return a*this.DTR},radiansToDegrees:function(a){return a*this.RTD}},AP.Matrix={create:function(){var a=new AP.Array(16);return this.identity(a),a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},clone:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},multiply:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return a[0]=s*c+t*g+u*k+v*o,a[1]=s*d+t*h+u*l+v*p,a[2]=s*e+t*i+u*m+v*q,a[3]=s*f+t*j+u*n+v*r,a[4]=w*c+x*g+y*k+z*o,a[5]=w*d+x*h+y*l+z*p,a[6]=w*e+x*i+y*m+z*q,a[7]=w*f+x*j+y*n+z*r,a[8]=A*c+B*g+C*k+D*o,a[9]=A*d+B*h+C*l+D*p,a[10]=A*e+B*i+C*m+D*q,a[11]=A*f+B*j+C*n+D*r,a[12]=E*c+F*g+G*k+H*o,a[13]=E*d+F*h+G*l+H*p,a[14]=E*e+F*i+G*m+H*q,a[15]=E*f+F*j+G*n+H*r,a},translate:function(a,b,c,d,e){return this.identity(b),b[12]=c,b[13]=d,b[14]=e,this.multiply(a,b),a},scale:function(a,b,c,d,e){return this.identity(b),b[0]=c,b[5]=d,b[10]=e,this.multiply(a,b),a}},AP.Quaternion={create:function(){var a=new AP.Array(4);return this.identity(a),a},identity:function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},clone:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},multiply:function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=g*h+d*k+e*j-f*i,a[1]=g*i-d*j+e*k+f*h,a[2]=g*j+d*i-e*h+f*k,a[3]=g*k-d*h-e*i-f*j,a},fromEuler:function(a,b,c,d){var e=b*AP.Math.ETQ,f=c*AP.Math.ETQ,g=d*AP.Math.ETQ,h=Math.cos(e),i=Math.sin(e),j=Math.cos(f),k=Math.sin(f),l=Math.cos(-g),m=Math.sin(-g),n=j*l,o=k*m;return a[0]=n*i+o*h,a[1]=k*l*h+j*m*i,a[2]=j*m*h-k*l*i,a[3]=n*h-o*i,a},toMatrix:function(a,b){AP.Matrix.identity(a);var c=b[0]*b[0],d=b[1]*b[1],e=b[2]*b[2],f=b[3]*b[3],g=2*b[0],h=2*b[1],i=2*b[3],j=b[1]*g,k=b[2]*g,l=b[2]*h,m=b[0]*i,n=b[1]*i,o=b[2]*i;return a[0]=f+c-d-e,a[1]=j-o,a[2]=k+n,a[4]=j+o,a[5]=f-c+d-e,a[6]=l-m,a[8]=k-n,a[9]=l+m,a[10]=f-c-d+e,a}},AP.Scene=function(a,b){this.origin={x:0,y:0},this.children=[],this.__rotationAngle=0,this.__sinRotation=0,this.__cosRotation=0,this.__pitchAngle=0,this.__pitchRatio=0,this.__yRatio=0,this.pitch("number"==typeof a?a:35),this.rotate("number"==typeof b?b:45)},AP.Scene.prototype={type:"scene",pitch:function(a){this.__pitchAngle=AP.Math.degreesToRadians(a),this.__pitchRatio=Math.sin(this.__pitchAngle),this.__yRatio=Math.cos(this.__pitchAngle)},rotate:function(a){this.__rotationAngle=AP.Math.degreesToRadians(a),this.__sinRotation=Math.sin(this.__rotationAngle),this.__cosRotation=Math.cos(this.__rotationAngle)},setOrigin:function(a,b){return this.origin.x=a,this.origin.y=b,this.origin},addChild:function(a){if(!~this.children.indexOf(a)&&a.type===AP.Node.prototype.type){this.children.push(a),a.parent=this;var b=this,c=function(a){a.scene=b;for(var d=0,e=a.children.length;e>d;d++)c(a.children[d])};c(a)}return a},removeChild:function(a){if(~this.children.indexOf(a)){this.children.splice(this.children.indexOf(a),1),a.parent=null;var b=function(a){a.scene=null;for(var c=0,d=a.children.length;d>c;c++)b(a.children[c])};b(a)}return a},projectNodes:function(){for(var a=function(b){b.project(!1);for(var c=0,d=b.children.length;d>c;c++)a(b.children[c])},b=0,c=this.children.length;c>b;b++)a(this.children[b])},sortNodes:function(){var a,b,c=[],d=function(a){c.push(a);for(var b=0,e=a.children.length;e>b;b++)d(a.children[b])};for(a=0,b=this.children.length;b>a;a++)d(this.children[a]);var e=function(a,b){return a.zDepth<b.zDepth?-1:a.zDepth>b.zDepth?1:a.zDepth===b.zDepth?a.zPriority<b.zPriority?-1:a.zPriority>b.zPriority?1:0:void 0};for(c.sort(e),a=0,b=c.length;b>a;a++)c[a].zIndex=a;return c}},AP.Node=function(a){this.id=a,this.scene=null,this.parent=null,this.children=[],this.px=0,this.py=0,this.vx=0,this.vy=0,this.vz=0,this.zPriority=0,this.zOffset=0,this.zDepth=0,this.zIndex=0,this.x=0,this.y=0,this.z=0,this.scaleX=1,this.scaleY=1,this.scaleZ=1,this.localRotation=!1,this.__rotationX=0,this.__rotationY=0,this.__rotationZ=0,this.__matrix=AP.Matrix.create(),this.__quaternion=AP.Quaternion.create(),this.__ms1=AP.Matrix.create(),this.__qs1=AP.Quaternion.create(),this.__qs2=AP.Quaternion.create()},AP.Node.prototype={type:"node",reset:function(){this.px=0,this.py=0,this.vx=0,this.vy=0,this.vz=0,this.zIndex=0,this.x=0,this.y=0,this.z=0,this.scaleX=1,this.scaleY=1,this.scaleZ=1,this.__rotationX=0,this.__rotationY=0,this.__rotationZ=0,this.zDepth=0,AP.Matrix.identity(this.__matrix),AP.Quaternion.identity(this.__quaternion)},translate:function(a,b,c){this.x=a,this.y=b,this.z=c},scale:function(a,b,c){this.scaleX=a,this.scaleY=b,this.scaleZ=c},rotate:function(a,b,c){if(this.localRotation){var d=a-this.__rotationX,e=b-this.__rotationY,f=c-this.__rotationZ;AP.Quaternion.fromEuler(this.__qs1,d,e,f),AP.Quaternion.clone(this.__quaternion,this.__qs2),AP.Quaternion.multiply(this.__quaternion,this.__qs1,this.__qs2)}else AP.Quaternion.fromEuler(this.__quaternion,a,b,c);this.__rotationX=a,this.__rotationY=b,this.__rotationZ=c},addChild:function(a){if(!~this.children.indexOf(a)&&a.type===this.type){this.children.push(a),a.parent=this;var b=this.scene,c=function(a){a.scene=b;for(var d=0,e=a.children.length;e>d;d++)c(a.children[d])};c(a)}return a},removeChild:function(a){if(~this.children.indexOf(a)){this.children.splice(this.children.indexOf(a),1),a.parent=null;var b=function(a){a.scene=null;for(var c=0,d=a.children.length;d>c;c++)b(a.children[c])};b(a)}return a},project:function(a){if(a="boolean"==typeof a?a:!0,AP.Matrix.identity(this.__matrix),a){for(var b=this.parent,c=[this,b],d=null===b,e=null;!d&&b.type!==AP.Scene.prototype.type;)b=b.parent,d=null===b,c.push(b);if(d)throw"node has not been added to a scene.";for(var f=c.length-2;f>=0;f--)e=c[f],AP.Matrix.translate(this.__matrix,this.__ms1,e.x,e.y,e.z),AP.Quaternion.toMatrix(this.__ms1,e.__quaternion),AP.Matrix.multiply(this.__matrix,this.__ms1),AP.Matrix.scale(this.__matrix,this.__ms1,e.scaleX,e.scaleY,e.scaleZ)}else this.parent.type===this.type&&AP.Matrix.clone(this.parent.__matrix,this.__matrix),AP.Matrix.translate(this.__matrix,this.__ms1,this.x,this.y,this.z),AP.Quaternion.toMatrix(this.__ms1,this.__quaternion),AP.Matrix.multiply(this.__matrix,this.__ms1),AP.Matrix.scale(this.__matrix,this.__ms1,this.scaleX,this.scaleY,this.scaleZ);this.px=this.py=this.zDepth=0,this.vx=this.__matrix[12],this.vy=this.__matrix[13],this.vz=this.__matrix[14],this.px+=this.vx*this.scene.__cosRotation,this.py+=this.vx*this.scene.__sinRotation,this.px-=this.vz*this.scene.__sinRotation,this.py+=this.vz*this.scene.__cosRotation,this.py*=this.scene.__pitchRatio,this.py-=this.vy*this.scene.__yRatio,this.zDepth+=this.vx*this.scene.__sinRotation,this.zDepth+=this.vz*this.scene.__cosRotation,this.zDepth*=this.scene.__yRatio,this.zDepth+=this.vy*this.scene.__pitchRatio,this.zDepth+=this.zOffset,this.px+=this.scene.origin.x,this.py+=this.scene.origin.y}},Object.defineProperty(AP.Node.prototype,"rotationX",{set:function(a){this.rotate(a,this.__rotationY,this.__rotationZ)},get:function(){return this.__rotationX}}),Object.defineProperty(AP.Node.prototype,"rotationY",{set:function(a){this.rotate(this.__rotationX,a,this.__rotationZ)},get:function(){return this.__rotationY}}),Object.defineProperty(AP.Node.prototype,"rotationZ",{set:function(a){this.rotate(this.__rotationX,this.__rotationY,a)},get:function(){return this.__rotationZ}});