<!-- fabric编辑器 zjfree 2022-10-17 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>fabric编辑器</title>

<link href="https://lib.baomitu.com/normalize/latest/normalize.min.css" rel="stylesheet">
<style>
	/* css style */
	input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
    }
    input[type="number"]{
        -moz-appearance: textfield;
    }

	html, body{
		margin:0;
		padding:0;
		height: 100%;
		width: 100%;
	}
	body{
		overflow: hidden;
	}

	#divMainLeft{
		position:absolute;
		top:0;
		left:0;
		bottom:0;
		width: max(15%, 300px);
		background-color: #eff;
		overflow:auto;
		border-right: solid 2px gray;
	}
	#divMainRight{
		position:absolute;
		top:0;
		right:0;
		bottom:0;
		width: max(15%, 300px);
		background-color: #eff;
		overflow:auto;
		border-left: solid 2px gray;
	}
	#divMainEditor{
		position:absolute;
		top:0;
		left: max(15%, 300px);
		right:max(15%, 300px);
		bottom:0;
		box-shadow: inset 0 0 30px rgba(0,0,0,0.2);
		overflow:auto;
		background-color: #eee;
	}

	#divMainLeft>.title{
		text-align: center;
		margin:0;
		padding:5px;
		border-bottom: solid 1px gray;
	}
	#divMainLeft>.block{
		padding:10px;
		border-bottom: solid 1px gray;
	}

	#myCanvas{
		border:solid 1px gray;
		display: block;
		background-color: #fff;
	}

	.hr{
		height:10px;
	}

	#divStatus{
		font-size: 12px;
		line-height: 1.3;
	}
	#divBtnList{
		line-height: 2;
	}
	
	#divMainRight>.block{
		padding:10px;
		border-bottom: solid 1px gray;
		line-height: 2;
	}

	#divMainRight>#divAttrList{
		line-height: 1.8;
		font-size:12px;
	}

	#divAttrList h3{
		background-color: #666;
		color:#fff;
		margin:0;
		padding:0 10px;
		margin-bottom: 5px;
		font-weight: normal;
		box-shadow: inset 0 0 5px #000;
		border-top-left-radius: 10px;
		border-top-right-radius: 10px;
	}

	#divAttrList .attr-group{
		margin-bottom: 10px;
		background-color: #fff;
		padding-bottom: 5px;
		border-top-left-radius: 10px;
		border-top-right-radius: 10px;
		border:solid 1px #666;
	}

	#divAttrList table{
		margin-right:10px;
	}
	#divAttrList table th{
		font-weight: normal;
		width: 5em;
		text-align: right;
		padding:0;
	}
	#divAttrList table td{
		text-align: left;
		padding:0;
	}
	#divAttrList table input{
		width:100%;
		text-align: center;
		display: block;
		padding: 0;
		margin:0;
	}
	#divAttrList table input[type=checkbox]{
		width:auto;
	}
</style>

<script src="https://lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://lib.baomitu.com/fabric.js/5.2.4/fabric.min.js"></script>
</head>
<body>
	
	<!-- 编辑器区域 -->
	<div id="divMainEditor">
		<canvas id="myCanvas">
			Your browser does not support the HTML5 canvas tag.
		</canvas>
	</div>

	<!-- 左侧导航 -->
	<div id="divMainLeft">
		<h3 class="title">fabric编辑器</h3>
		<div id="divBtnList" class="block">
			<button onclick="Feditor.deleteAll();">清空所有</button>
			<button onclick="Feditor.reload();">重新加载</button>
			<button onclick="Feditor.save();">保存</button>
			<hr>
			<button onclick="Feditor.addRect();">添加 Rect</button>
			<button onclick="Feditor.addCircle();">添加 Circle</button>
			<button onclick="Feditor.addTriangle();">添加 Triangle</button>
			<button onclick="Feditor.addEllipse();">添加 Ellipse</button>
			<button onclick="Feditor.addLine();">添加 Line</button>
			<button onclick="Feditor.addPolygon();">添加 Polygon</button>
			<button onclick="Feditor.addPolyline(20);">添加 Polyline</button>
			<button onclick="Feditor.addRing(0, 300, 400, 200, 10, 60);">添加 Ring</button>
			<button onclick="Feditor.addRing(0, 360, 200, 200, 30, 60);">添加 Ring</button>
			<button onclick="Feditor.addText();">添加 Text</button>
			<button onclick="Feditor.addPath();">添加 Path</button>
			<button onclick="Feditor.addTextbox();">添加 Textbox</button>
			<button onclick="Feditor.addImage();">添加 Image</button>
			<button onclick="Feditor.addImage('../static/img/test.svg');">添加 ImageSvg</button>
			<button onclick="Feditor.addButton();">添加 Button</button>
			
		</div>
		<div id="divStatus" class="block">就绪</div>
	</div>
	
	<!-- 右侧属性框 -->
	<div id="divMainRight">
		<div class="block" style="font-size:14px;">
			<button onclick="Feditor.copy();">复制</button>
			<button onclick="Feditor.delete();">删除</button>
			<button onclick="Feditor.toGroup();">组合</button>
			<button onclick="Feditor.splitGroup();">拆分</button>
			<br>
			<button onclick="Feditor.bringToFront();">置顶</button>
			<button onclick="Feditor.bringForward();">上层</button>
			<button onclick="Feditor.sendToBack();">置底</button>
			<button onclick="Feditor.sendBackwards();">下层</button>
			<br>
			<button onclick="Feditor.align('left');">左</button>
			<button onclick="Feditor.align('right');">右</button>
			<button onclick="Feditor.align('top');">上</button>
			<button onclick="Feditor.align('bottom');">下</button>
			<button onclick="Feditor.align('vcenter');">竖直</button>
			<button onclick="Feditor.align('hcenter');">水平</button>
			<br>
			<button onclick="Feditor.align('mhcenter');">水平居中</button>
			<button onclick="Feditor.align('mvcenter');">竖直居中</button>
			<br>
			<button onclick="Feditor.align('mhavg');">水平均分</button>
			<button onclick="Feditor.align('mvavg');">竖直均分</button>
			<br>
			<button onclick="">复制样式</button>
			<button onclick="">粘贴样式</button>
			<br>
		</div>
		<div id="divAttrList" class="block">
			
			<div class="attr-group">
				<h3>基础属性</h3>
				<table>
					<tr>
						<th>距左:</th>
						<td><input id="attr_left" type="number" value="0" /></td>
						<th>距顶:</th>
						<td><input id="attr_top" type="number" value="0" /></td>
					</tr>
					<tr>
						<th>宽度:</th>
						<td><input id="attr_width" type="number" value="0" /></td>
						<th>高度:</th>
						<td><input id="attr_height" type="number" value="0" /></td>
					</tr>
					<tr>
						<th>X缩放:</th>
						<td><input id="attr_scaleX" type="number" value="0" data-fix="2" /></td>
						<th>Y缩放:</th>
						<td><input id="attr_scaleY" type="number" value="0" data-fix="2" /></td>
					</tr>
					<tr>
						<th>X翻转:</th>
						<td><input id="attr_flipX" type="checkbox" value="1" /></td>
						<th>Y翻转:</th>
						<td><input id="attr_flipY" type="checkbox" value="1" /></td>
					</tr>
					<tr>
						<th>X倾斜:</th>
						<td><input id="attr_skewX" type="number" value="0" data-fix="2" /></td>
						<th>Y倾斜:</th>
						<td><input id="attr_skewY" type="number" value="0" data-fix="2" /></td>
					</tr>
					<tr>
						<th>旋转角度:</th>
						<td colspan="3"><input id="attr_angle" type="number" value="0" /></td>
					</tr>
				</table>
				
			</div>

			<div class="attr-group">
				<h3>样式属性</h3>
				<table>
					<tr>
						<th>填充颜色:</th>
						<td><input id="attr_fill" type="text" value="" /></td>
						<th>不透明度:</th>
						<td><input id="attr_opacity" type="number" value="1" data-fix="2" /></td>
					</tr>
					<tr>
						<th>边框颜色:</th>
						<td><input id="attr_stroke" type="text" value="" /></td>
						<th>边框宽度:</th>
						<td><input id="attr_strokeWidth" type="number" value="1" data-fix="2" /></td>
					</tr>
					<tr>
						<th>阴影:</th>
						<td colspan="3"><input id="attr_shadow" type="text" value="" /></td>
					</tr>
				</table>
			</div>

			<div class="attr-group">
				<h3>画板属性</h3>
				<table>
					<tr>
						<th>宽度:</th>
						<td><input id="attr_page_width" type="number" value="0" /></td>
						<th>高度:</th>
						<td><input id="attr_page_height" type="number" value="0" /></td>
					</tr>
				</table>
			</div>
		</div>
	</div>

	<script>
	$(function(){
		// JS
		Feditor.init($('#myCanvas'));

		window.setInterval(function(){
			let str = '共' + Feditor.canvas._objects.length + '个元素；';
			let obj = Feditor.canvas.getActiveObject();
			if (obj != null)
			{
				if (obj.type == 'activeSelection')
				{
					str += '选中' + obj.size() + '个'
				}
				else
				{
					str += '选中:' + obj.type;
				}
			}
			$('#divStatus').html(str);
		}, 500);
	});

	var FeditorData = {
		elIndex:1,
		page:{
			width:1000,
			height:600,
		},
		list:[],
	};

	var Feditor = {
		el:null,
		canvas:null,
		width: 0,
		height: 0,
		init:function(el){
			this.el = el;
			
			$('#attr_page_width').val(FeditorData.page.width);
			$('#attr_page_height').val(FeditorData.page.height);
			this.width = FeditorData.page.width * window.devicePixelRatio;
			this.height = FeditorData.page.height * window.devicePixelRatio;
			el.prop('width', this.width);
			el.prop('height', this.height);
			window.onresize = this.resize;

			this.canvas = new fabric.Canvas(el.attr('id'),{
				preserveObjectStacking:true,
				selectionKey:'ctrlKey',
			});
			//fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';
      		fabric.Text.prototype.originX = 'center';
			fabric.Object.prototype.transparentCorners = false;

			this.canvas.on('selection:created', function(options) {
				if (options.selected.length != 1) return;
				Feditor.bindObj(options.selected[0]);
			});
			this.canvas.on('selection:updated', function(options) {
				if (options.selected.length != 1) return;
				Feditor.bindObj(options.selected[0]);
			});
			this.canvas.on('selection:cleared', function(options) {
				console.log(options);
			});
			this.canvas.on('object:moving', function(options) {
				if (!options.target._eid) return;
				Feditor.bindObj(options.target);
			});
			this.canvas.on('object:scaling', function(options) {
				if (!options.target._eid) return;
				Feditor.bindObj(options.target);
			});
			this.canvas.on('object:rotating', function(options) {
				if (!options.target._eid) return;
				Feditor.bindObj(options.target);
			});
			this.canvas.on('object:skewing', function(options) {
				if (!options.target._eid) return;
				Feditor.bindObj(options.target);
			});
			this.canvas.on('object:resizing', function(options) {
				if (!options.target._eid) return;
				Feditor.bindObj(options.target);
			});

			// 绑定编辑值
			$('#attr_page_width, #attr_page_height').change(function(){
				let w = parseInt($('#attr_page_width').val());
				let h = parseInt($('#attr_page_height').val());
				FeditorData.page.width = w;
				FeditorData.page.height = h;

				Feditor.canvas.setDimensions({
					width: w * window.devicePixelRatio,
					height: h * window.devicePixelRatio,
				});
			});
			$('#divAttrList input').change(function(){
				let key = $(this).attr('id').substr(5);
				if (key.indexOf('page_') === 0) return;

				let obj = Feditor.canvas.getActiveObject();
				if (!obj || obj.type == 'activeSelection') return;

				if ($(this).attr('type') == 'checkbox')
				{
					obj.set(key, this.checked);
				}
				else if (key == 'angle')
				{
					obj.rotate($(this).val());
					Feditor.bindObj(obj);
				}
				else if (typeof(obj[key]) == 'number')
				{
					obj.set(key, parseFloat($(this).val()));
				}
				else
				{
					obj.set(key, $(this).val());
				}

				Feditor.canvas.renderAll();
			});
		},

		resize:function(){},

		bindObj:function(obj){
			$('#divAttrList input').each(function(){
				let key = $(this).attr('id').substr(5);
				if (key.indexOf('page_') === 0) return;
				if ($(this).attr('type') == 'checkbox')
				{
					this.checked = obj[key];
				}
				else if (typeof(obj[key]) == 'number')
				{
					$(this).val(obj[key].toFixed($(this).data('fix') || 0));
				}
				else
				{
					$(this).val(obj[key]);
				}
			});
		},

		/////// 层级处理
		bringToFront:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.bringToFront();
		},
		bringForward:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.bringForward();
		},
		sendToBack:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.sendToBack();
		},
		sendBackwards:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.sendBackwards();
		},

		toGroup:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj || obj.type != 'activeSelection') return;
			obj.toGroup();
			this.canvas.renderAll();
		},
		splitGroup:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj || obj.type == 'activeSelection') return;
			obj.toActiveSelection();
			this.canvas.renderAll();
		},

		/////// 元素添加

		addItem:function(item, active = true){
			this.canvas.add(item);
			item.set('_eid', FeditorData.elIndex++);
			if (active)
			{
				this.canvas.setActiveObject(item);
			}

			return item;
		},

		addRect:function(){
			let item = new fabric.Rect({
				width: 100, height: 100, left: 50, top: 50,
				fill: '#99F',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addCircle:function(){
			let item = new fabric.Circle({
				radius: 50, left: 50, top: 50,
				fill: '#9F9',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addTriangle:function(){
			let item = new fabric.Triangle({
				width: 100, height: 100, left: 50, top: 50,
				fill: '#F99',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},

		addEllipse:function(){
			let item = new fabric.Ellipse({
				rx: 80, ry: 40, left: 50, top: 50,
				fill: '#FF9',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},

		addLine:function(){
			let item = new fabric.Line([10, 10, 100, 100], {
				fill: 'green',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addPolygon:function(num){
			num = num || 5;
			let list = [];
			let bo = true;
			for (let i=0; i<360; i+=360/num/2)
			{
				bo = !bo;
				let du = i * 0.017453293;
				list.push({
					x: 200 + Math.sin(du) * (bo ? 100 : 40),
					y: 200 + Math.cos(du) * (bo ? 100 : 40),
				});
			}

			let item = new fabric.Polygon(list, {
				fill: '#9F9',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addPolyline:function(num){
			num = num || 5;
			let list = [];
			let bo = true;
			for (let i=0; i<=360; i+=360/num/2)
			{
				bo = !bo;
				let du = i * 0.017453293;
				list.push({
					x: 200 + Math.sin(du) * (bo ? 100 : 40),
					y: 200 + Math.cos(du) * (bo ? 100 : 40),
				});
			}

			let item = new fabric.Polyline(list, {
				fill: 'transparent',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addRing:function(angle1, angle2, x, y, r1, r2){
			let point1 = {};
			let point2 = {};
			let point3 = {};
			let point4 = {};
			let isBig = 0
			angle1 = angle1 % 360;
			angle2 = angle2 % 360;

			if (angle2 > 180) {
				isBig = 1
			}

			let item = null;
			if (!angle2) {
				point1.x = r1 + x;
				point1.y = y;
				point2.x = r2 + x;
				point2.y = y;
				item = new fabric.Path(`M${point1.x},${point1.y} A${r1},${r1} 0 0,1 ${point1.x - 2 * r1},${point1.y}
				A${r1},${r1} 0 0,1 ${point1.x},${point1.y}
				M${point2.x},${point2.y} A${r2},${r2} 0 0,1 ${point2.x - 2 * r2},${point2.y}
				A${r2},${r2} 0 0,1 ${point2.x},${point2.y}`, {
					stroke: '#000',
					fill: '#F99',
				})
			} else {
				let d1 = angle1 / 180 * Math.PI;
				let d2 = (angle1 + angle2) / 180 * Math.PI;
				point1.x = r1 * Math.cos(d1) + x;
				point1.y = r1 * Math.sin(d1) + y;
				point2.x = r2 * Math.cos(d1) + x;
				point2.y = r2 * Math.sin(d1) + y;
				point3.x = r2 * Math.cos(d2) + x;
				point3.y = r2 * Math.sin(d2) + y;
				point4.x = r1 * Math.cos(d2) + x;
				point4.y = r1 * Math.sin(d2) + y;
				item = new fabric.Path(`M${point1.x},${point1.y} L${point2.x},${point2.y} A${r2},${r2} 0 ${isBig},1 ${point3.x},${point3.y} L${point4.x},${point4.y} A${r1},${r1} 0 ${isBig},0 ${point1.x},${point1.y}`, {
					stroke: '#000',
					fill: '#F99',
					// hasControls: false
				});
			}
			
			this.addItem(item);
		},

		addText:function(str){
			str = str || 'Hello 中国123!';
			let item = new fabric.Text(str, {
				left: 100,
				top: 100,
				strokeWidth:0,
				fontSize: 40,
				fill: 'green',
				textBackgroundColor: 'transparent',
				originX:'left',
				originY:'top',
			});

			this.addItem(item);
		},

		addPath:function(){
			let item = new fabric.Path('M 0 0 L 300 100 L 200 300 z');
			item.set({ stroke: 'green', fill:'transparent', left:100, top:100 });

			this.addItem(item);
		},
		
		addTextbox:function(str){
			str = str || 'Hello 中国123!';
			let item = new fabric.Textbox(str, {
				left: 100,
				top: 100,
				strokeWidth:0,
				fontSize: 40,
				fill: 'green',
				textBackgroundColor: 'transparent'
			});

			this.addItem(item);
		},

		addImage:function(url){
			if (!url)
			{
				url = window.prompt('输入图片路径：', '../static/img/img01.png');
				if (!url) return;
			}
			
			fabric.Image.fromURL(url, function(image) {
				image.set({
					left: 100,
					top: 100,
					shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', offsetX: 10, offsetY: 10, blur: 10 })
				});
				image.scale(0.3).setCoords();
				
				Feditor.addItem(image);
			});
		},

		addButton:function(str){
			str = str || 'button';
			let rect = new fabric.Rect({ width: 200, height: 50, fill: '#faa', rx: 10, ry: 10, strokeWidth:0 });
			let text = new fabric.Text(str, { fontSize: 20, left:100, top:25, fontFamily: 'Georgia', strokeWidth:0, textAlign: 'center', originX:'center', originY:'center', });
			let group = new fabric.Group([ rect, text ], { left: 100, top: 100, hasControls: false, hasBorders:false });
			
			this.addItem(group);
			this.canvas.calcOffset();

			group.on('mouseover', function() {
				rect.fill = '#F00';
				group.dirty = true;
			});
			group.on('mouseout', function() {
				rect.fill = '#FAA';
				group.dirty = true;
			});
		},

		/// 操作

		copy:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			if (obj.type != 'activeSelection')
			{
				obj.clone(function(objClone){
					objClone.set({
						top:objClone.top+10,
						left:objClone.left+10,
					});
					
					Feditor.addItem(objClone);
				});
			}
			else
			{
				for (let r of obj._objects)
				{
					r.clone(function(objClone){
						objClone.set({
							top:10+Feditor.canvas._activeObject.top+objClone.top+Feditor.canvas._activeObject.height/2,
							left:10+Feditor.canvas._activeObject.left+objClone.left+Feditor.canvas._activeObject.width/2,
						});

						objClone.set('canvas', Feditor.canvas);
						objClone.setCoords();
						
						Feditor.addItem(objClone, false);
					});
				}
			}
		},

		delete:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			if (obj.type != 'activeSelection')
			{
				this.canvas.remove(obj);
			}
			else
			{
				for (let r of obj._objects)
				{
					this.canvas.remove(r);
				}
			}

			this.canvas._activeObject = null;
		},

		deleteAll:function(){
			this.canvas._objects = [];
			this.canvas._activeObject = null;
			this.canvas.renderAll();
		},

		save:function(){
			let json = this.canvas.toJSON(['_eid']);
			let saveData = {
				editor:FeditorData,
				data:json,
			};
			window.localStorage.setItem('Feditor_data', JSON.stringify(saveData));
			alert('保存成功');
		},

		reload:function(){
			let arr = window.localStorage.getItem('Feditor_data');
			if (!arr) return;
			let saveData = JSON.parse(arr);
			FeditorData = saveData.editor;

			this.canvas.setDimensions({
				width: FeditorData.page.width * window.devicePixelRatio,
				height: FeditorData.page.height * window.devicePixelRatio,
			});
			$('#attr_page_width').val(FeditorData.page.width);
			$('#attr_page_height').val(FeditorData.page.height);

			this.canvas.loadFromJSON(saveData.data, function(){
				Feditor.canvas.renderAll();
			});
		},

		/// 对齐
		align:function(type){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;

			if (type == 'mhcenter')
			{
				obj.set({left:this.canvas.width / 2 - obj.width / 2});
				this.canvas.renderAll();
				return;
			}
			if (type == 'mvcenter')
			{
				obj.set({top:this.canvas.height / 2 - obj.height / 2});
				this.canvas.renderAll();
				return;
			}

			if (obj.type != 'activeSelection') return;

			if (type == 'mhavg')
			{
				obj._objects.sort((a, b) => {
                	return a.left - b.left;
				});

				let totalW = 0;
				obj._objects.forEach(function(item){
					totalW += item.width;
				});

				let stepW = (obj.width - totalW) / (obj.size() - 1);
				let leftW = 0;
				for (let i=0; i<obj.size(); i++)
				{
					obj._objects[i].set({left:leftW - obj.width/2});
					leftW += obj._objects[i].width * obj._objects[i].scaleX + stepW;
				}
				this.canvas.renderAll();
				return;
			}
			if (type == 'mvavg')
			{
				obj._objects.sort((a, b) => {
                	return a.top - b.top;
				});

				let totalH = 0;
				obj._objects.forEach(function(item){
					totalH += item.height;
				});

				let stepH = (obj.height - totalH) / (obj.size() - 1);
				let leftH = 0;
				for (let i=0; i<obj.size(); i++)
				{
					obj._objects[i].set({top:leftH - obj.height/2});
					leftH += obj._objects[i].height * obj._objects[i].scaleY + stepH;
				}
				this.canvas.renderAll();
				return;
			}

			obj._objects.forEach(function(item){
				let w = item.width * item.scaleX;
				let h = item.height * item.scaleY;
				switch(type)
				{
					case 'left':
						item.set({left:0 - obj.width * 0.5})
						break;
					case 'top':
						item.set({top:0 - obj.height * 0.5})
						break;
					case 'right':
						item.set({left:obj.width * 0.5 - w})
						break;
					case 'bottom':
						item.set({top:obj.height * 0.5 - h})
						break;
					case 'vcenter':
						item.set({left:-w/2})
						break;
					case 'hcenter':
						item.set({top:-h/2})
						break;
				}
			});

			this.canvas.renderAll();
		},
	};

	</script>

</body>
</html>