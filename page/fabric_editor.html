<!-- fabric编辑器 zjfree 2022-10-17 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>fabric编辑器</title>

<link href="https://lib.baomitu.com/normalize/latest/normalize.min.css" rel="stylesheet">
<style>
	/* css style */
	input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
    }
    input[type="number"]{
        -moz-appearance: textfield;
    }

	html, body{
		margin:0;
		padding:0;
		height: 100%;
		width: 100%;
	}
	body{
		overflow: hidden;
	}

	#divMainLeft{
		position:absolute;
		top:0;
		left:0;
		bottom:0;
		width: max(15%, 300px);
		background-color: #eff;
		overflow:auto;
		border-right: solid 2px gray;
	}
	#divMainRight{
		position:absolute;
		top:0;
		right:0;
		bottom:0;
		width: max(15%, 300px);
		background-color: #eff;
		overflow:auto;
		border-left: solid 2px gray;
	}
	#divMainEditor{
		position:absolute;
		top:0;
		left: max(15%, 300px);
		right:max(15%, 300px);
		bottom:0;
		box-shadow: inset 0 0 30px rgba(0,0,0,0.2);
		overflow:auto;
		background-color: #eee;
	}

	#divMainLeft>.title{
		text-align: center;
		margin:0;
		padding:5px;
		border-bottom: solid 1px gray;
	}
	#divMainLeft>.block{
		padding:10px;
		border-bottom: solid 1px gray;
	}

	.canvas-container{
		margin:0 auto;
	}

	#myCanvas{
		border:solid 1px gray;
		display: block;
		background-color: #fff;
	}

	.hr{
		height:10px;
	}

	#divStatus{
		font-size: 12px;
		line-height: 1.3;
	}
	#divBtnList{
		line-height: 2;
	}
	
	#divMainRight>.block{
		padding:10px;
		border-bottom: solid 1px gray;
		line-height: 2;
	}

	#divMainRight>#divAttrList{
		line-height: 1.8;
		font-size:12px;
	}

	#divAttrList h3{
		background-color: #666;
		color:#fff;
		margin:0;
		padding:0 10px;
		margin-bottom: 5px;
		font-weight: normal;
		box-shadow: inset 0 0 5px #000;
		border-top-left-radius: 10px;
		border-top-right-radius: 10px;
	}

	#divAttrList .attr-group{
		margin-bottom: 10px;
		background-color: #fff;
		padding-bottom: 5px;
		border-top-left-radius: 10px;
		border-top-right-radius: 10px;
		border:solid 1px #666;
	}

	#divAttrList table{
		margin-right:10px;
	}
	#divAttrList table th{
		font-weight: normal;
		width: 5em;
		text-align: right;
		padding:0;
		vertical-align: text-top;
	}
	#divAttrList table td{
		text-align: left;
		padding:0;
	}
	#divAttrList table input,
	#divAttrList table select,
	#divAttrList table textarea
	{
		width:100%;
		text-align: center;
		display: block;
		padding: 0;
		margin:0;
	}
	#divAttrList table textarea{
		resize: vertical;
		text-align: left;
		height: 4em;
	}
	#divAttrList table input[type=checkbox]{
		width:auto;
		display: inline;
	}

	.h3-btn{
		float:right;
		cursor: pointer;
		color:#999;
	}
	.h3-btn:hover{
		color:#0F0;
	}

	.attr-type{
		display: none;
	}

	.hhide{
		visibility: hidden;
	}
</style>

<script src="https://lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://lib.baomitu.com/fabric.js/5.2.4/fabric.min.js"></script>
</head>
<body>
	
	<!-- 编辑器区域 -->
	<div id="divMainEditor">
		<canvas id="myCanvas">
			Your browser does not support the HTML5 canvas tag.
		</canvas>
	</div>

	<!-- 左侧导航 -->
	<div id="divMainLeft">
		<h3 class="title">fabric编辑器</h3>
		<div id="divBtnList" class="block">
			<button onclick="Feditor.deleteAll();">清空所有</button>
			<button onclick="Feditor.reload();">重新加载</button>
			<button onclick="Feditor.save();">保存</button>
			<hr>
			<button onclick="Feditor.addRect();">添加 Rect</button>
			<button onclick="Feditor.addCircle();">添加 Circle</button>
			<button onclick="Feditor.addTriangle();">添加 Triangle</button>
			<button onclick="Feditor.addEllipse();">添加 Ellipse</button>
			<button onclick="Feditor.addLine();">添加 Line</button>
			<button onclick="Feditor.addPolygon();">添加 Polygon</button>
			<button onclick="Feditor.addPolyline(20);">添加 Polyline</button>
			<button onclick="Feditor.addRing(0, 300, 400, 200, 10, 60);">添加 Ring</button>
			<button onclick="Feditor.addRing(0, 360, 200, 200, 30, 60);">添加 Ring</button>
			<button onclick="Feditor.addText();">添加 Text</button>
			<button onclick="Feditor.addPath();">添加 Path</button>
			<button onclick="Feditor.addTextbox();">添加 Textbox</button>
			<button onclick="Feditor.addImage();">添加 Image</button>
			<button onclick="Feditor.addImage('../static/img/test.svg');">添加 ImageSvg</button>
			<button onclick="Feditor.addButton();">添加 Button</button>
			<button onclick="Feditor.addPipe();">添加 Pipe</button>
			<button onclick="Feditor.addTextRect();">添加 TextRect</button>
			
		</div>
		<div id="divStatus" class="block">就绪</div>
	</div>
	
	<!-- 右侧属性框 -->
	<div id="divMainRight">
		<div class="block" style="font-size:14px;">
			<button onclick="Feditor.copy();">复制</button>
			<button onclick="Feditor.delete();">删除</button>
			<button onclick="Feditor.toGroup();">组合</button>
			<button onclick="Feditor.splitGroup();">拆分</button>
			<br>
			<button onclick="Feditor.bringToFront();">置顶</button>
			<button onclick="Feditor.bringForward();">上层</button>
			<button onclick="Feditor.sendToBack();">置底</button>
			<button onclick="Feditor.sendBackwards();">下层</button>
			<br>
			<button onclick="Feditor.align('left');">左</button>
			<button onclick="Feditor.align('right');">右</button>
			<button onclick="Feditor.align('top');">上</button>
			<button onclick="Feditor.align('bottom');">下</button>
			<button onclick="Feditor.align('vcenter');">竖直</button>
			<button onclick="Feditor.align('hcenter');">水平</button>
			<br>
			<button onclick="Feditor.align('mhcenter');">水平居中</button>
			<button onclick="Feditor.align('mvcenter');">竖直居中</button>
			<br>
			<button onclick="Feditor.align('mhavg');">水平均分</button>
			<button onclick="Feditor.align('mvavg');">竖直均分</button>
			<br>
			<button onclick="">复制样式</button>
			<button onclick="">粘贴样式</button>
			<br>
		</div>
		<div id="divAttrList" class="block">
			
			<div class="attr-group">
				<h3>基础属性 <span class="h3-btn" onclick="Feditor.attrReset();">Reset</span></h3>
				<table>
					<tr>
						<th>距左:</th>
						<td><input class="attr" id="attr_left" type="number" value="0" /></td>
						<th>距顶:</th>
						<td><input class="attr" id="attr_top" type="number" value="0" /></td>
					</tr>
					<tr>
						<th>宽度:</th>
						<td><input class="attr" id="attr_width" type="number" value="0" /></td>
						<th>高度:</th>
						<td><input class="attr" id="attr_height" type="number" value="0" /></td>
					</tr>
					<tr>
						<th>X缩放:</th>
						<td><input class="attr" id="attr_scaleX" type="number" value="0" data-fix="2" /></td>
						<th>Y缩放:</th>
						<td><input class="attr" id="attr_scaleY" type="number" value="0" data-fix="2" /></td>
					</tr>
					<tr>
						<th>X翻转:</th>
						<td><input class="attr" id="attr_flipX" type="checkbox" value="1" /></td>
						<th>Y翻转:</th>
						<td><input class="attr" id="attr_flipY" type="checkbox" value="1" /></td>
					</tr>
					<tr>
						<th>X倾斜:</th>
						<td><input class="attr" id="attr_skewX" type="number" value="0" data-fix="2" /></td>
						<th>Y倾斜:</th>
						<td><input class="attr" id="attr_skewY" type="number" value="0" data-fix="2" /></td>
					</tr>
					<tr>
						<th>X对齐:</th>
						<td>
							<select class="attr" id="attr_originX">
								<option value="left">left</option>
								<option value="center">center</option>
								<option value="right">right</option>
							</select>
						</td>
						<th>Y对齐:</th>
						<td>
							<select class="attr" id="attr_originY">
								<option value="top">top</option>
								<option value="center">center</option>
								<option value="bottom">bottom</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>旋转角度:</th>
						<td colspan="3"><input class="attr" id="attr_angle" type="number" value="0" /></td>
					</tr>
				</table>
				
			</div>

			<div class="attr-group">
				<h3>样式属性</h3>
				<table>
					<tr>
						<th>填充颜色:</th>
						<td><input class="attr" id="attr_fill" type="text" value="" /></td>
						<th>不透明度:</th>
						<td><input class="attr" id="attr_opacity" type="number" value="1" data-fix="2" /></td>
					</tr>
					<tr>
						<th>边框颜色:</th>
						<td><input class="attr" id="attr_stroke" type="text" value="" /></td>
						<th>边框宽度:</th>
						<td><input class="attr" id="attr_strokeWidth" type="number" value="1" data-fix="2" /></td>
					</tr>
					<tr>
						<th>阴影:</th>
						<td colspan="3"><input class="attr" id="attr_shadow" type="text" value="" /></td>
					</tr>
				</table>
			</div>

			<div class="attr-group">
				<h3>画板属性</h3>
				<table>
					<tr>
						<th>宽度:</th>
						<td><input class="attrPage" id="attrPage_width" type="number" value="0" /></td>
						<th>高度:</th>
						<td><input class="attrPage" id="attrPage_height" type="number" value="0" /></td>
					</tr>
					<tr>
						<th>背景色:</th>
						<td><input class="attrPage" id="attrPage_backgroundColor" type="text" value="" /></td>
						<th>放大系数:</th>
						<td><input class="attrPage" id="attrPage_zoom" type="number" value="1" step="0.01" /></td>
					</tr>
				</table>
			</div>
			
			<div class="attr-group">
				<h3>属性绑定</h3>
				<table>
					<tr>
						<th>是否显示:</th>
						<td><input class="attrBind" id="attrBind_visable" type="text" value="1" /></td>
						<th>不透明度:</th>
						<td><input class="attrBind" id="attrBind_opacity" type="text" value="1" /></td>
					</tr>
					<tr>
						<th>动画1:</th>
						<td colspan="3"><input class="attrBind" id="attrBind_am1" type="text" value="" /></td>
					</tr>
					<tr>
						<th>动画2:</th>
						<td colspan="3"><input class="attrBind" id="attrBind_am2" type="text" value="" /></td>
					</tr>
					<tr>
						<th>动画3:</th>
						<td colspan="3"><input class="attrBind" id="attrBind_am3" type="text" value="" /></td>
					</tr>
				</table>
			</div>

			<div class="attr-group attr-type attr-type-text">
				<h3>文字属性</h3>
				<table>
					<tr>
						<th>文字内容:</th>
						<td colspan="3"><textarea class="attr" id="attr_text"></textarea></td>
					</tr>
					<tr>
						<th>字背景色:</th>
						<td><input class="attr" id="attr_textBackgroundColor" type="text" value="" /></td>
						<th>文字大小:</th>
						<td><input class="attr" id="attr_fontSize" type="number" value="1" data-fix="2" /></td>
					</tr>
					<tr>
						<th>样式:</th>
						<td>
							<select class="attr" id="attr_fontStyle">
								<option value="normal">normal</option>
								<option value="italic">italic</option>
								<option value="oblique">oblique</option>
							</select>
						</td>
						<th>行高:</th>
						<td><input class="attr" id="attr_lineHeight" type="number" value="1" data-fix="2" /></td>
					</tr>
					<tr>
						<th>字体:</th>
						<td colspan="3"><input class="attr" id="attr_fontFamily" type="text" value="" /></td>
					</tr>
					<tr>
						<th>粗体:</th>
						<td>
							<select class="attr" id="attr_fontWeight">
								<option value="normal">normal</option>
								<option value="bold">bold</option>
								<option value="bolder">bolder</option>
								<option value="lighter">lighter</option>
							</select>
						</td>
						<th>对齐:</th>
						<td>
							<select class="attr" id="attr_textAlign">
								<option value="left">left</option>
								<option value="center">center</option>
								<option value="right">right</option>
							</select>
						</td>
					</tr>
					<tr>
						<th>划线:</th>
						<td colspan="3">
							&nbsp;
							<label><input class="attr" id="attr_underline" type="checkbox" value="1" /> 下划线</label>
							&nbsp;
							<label><input class="attr" id="attr_linethrough" type="checkbox" value="1" /> 中划线</label>
							&nbsp;
							<label><input class="attr" id="attr_overline" type="checkbox" value="1" /> 上划线</label>
						</td>
					</tr>
				</table>
			</div>

			<div class="attr-group attr-type attr-type-rect">
				<h3>Rect 属性</h3>
				<table>
					<tr>
						<th>RX:</th>
						<td><input class="attr" id="attr_rx" type="number" value="0" /></td>
						<th>RY:</th>
						<td><input class="attr" id="attr_ry" type="number" value="0" /></td>
					</tr>
				</table>
			</div>
			<div class="attr-group attr-type attr-type-circle">
				<h3>Circle 属性</h3>
				<table>
					<tr>
						<th>半径:</th>
						<td><input class="attr" id="attr_radius" type="number" value="0" /></td>
						<th></th>
						<td><input class="hhide" /></td>
					</tr>
				</table>
			</div>
			<div class="attr-group attr-type attr-type-ellipse">
				<h3>Ellipse 属性</h3>
				<table>
					<tr>
						<th>RX:</th>
						<td><input class="attr" id="attr_rx" type="number" value="0" /></td>
						<th>RY:</th>
						<td><input class="attr" id="attr_ry" type="number" value="0" /></td>
					</tr>
				</table>
			</div>
			<div class="attr-group attr-type attr-type-line">
				<h3>Line 属性</h3>
				<table>
					<tr>
						<th>X1:</th>
						<td><input class="attr" id="attr_x1" type="number" value="0" /></td>
						<th>Y1:</th>
						<td><input class="attr" id="attr_y1" type="number" value="0" /></td>
					</tr>
					<tr>
						<th>X2:</th>
						<td><input class="attr" id="attr_x2" type="number" value="0" /></td>
						<th>Y2:</th>
						<td><input class="attr" id="attr_y2" type="number" value="0" /></td>
					</tr>
				</table>
			</div>
			<div class="attr-group attr-type attr-type-TextRect">
				<h3>TextRect 属性</h3>
				<table>
					<tr>
						<th>RX:</th>
						<td><input class="attr" id="attr_rx" type="number" value="0" /></td>
						<th>RY:</th>
						<td><input class="attr" id="attr_ry" type="number" value="0" /></td>
					</tr>
					<tr>
						<th>文字内容:</th>
						<td><input class="attr" id="attr_text" type="text" value="" /></td>
						<th>文字颜色:</th>
						<td><input class="attr" id="attr_textFill" type="text" value="" /></td>
					</tr>
				</table>
			</div>
			<div class="attr-group attr-type attr-type-Pipe">
				<h3>Pipe 属性</h3>
				<table>
					<tr>
						<th>管道颜色:</th>
						<td><input class="attr" id="attr_pipeBackColor" type="text" value="" /></td>
						<th>流体颜色:</th>
						<td><input class="attr" id="attr_pipeColor" type="text" value="" /></td>
					</tr>
					<tr>
						<th>管道直径:</th>
						<td><input class="attr" id="attr_pipeWidth" type="number" value="" /></td>
						<th>流体透明:</th>
						<td><input class="attr" id="attr_pipeOpacity" type="number" value="1" data-fix="2" /></td>
					</tr>
				</table>
			</div>
			
		</div>
	</div>

	<script>
	$(function(){
		// JS
		Feditor.init($('#myCanvas'));

		window.setInterval(function(){
			let str = '共' + Feditor.canvas._objects.length + '个元素；';
			let obj = Feditor.canvas.getActiveObject();
			if (obj != null)
			{
				if (obj.type == 'activeSelection')
				{
					str += '选中' + obj.size() + '个'
				}
				else
				{
					str += '选中:' + obj.type;
				}
			}
			$('#divStatus').html(str);
		}, 500);
	});

	var FeditorData = {
		elIndex:1,
		page:{
			width:1000,
			height:600,
			zoom:1,
		},
		list:[],
	};

	var Feditor = {
		el:null,
		canvas:null,
		width: 0,
		height: 0,
		pipePList:[],
		pipeCur:null,

		init:function(el){
			this.el = el;
			
			$('#attrPage_width').val(FeditorData.page.width);
			$('#attrPage_height').val(FeditorData.page.height);
			this.width = FeditorData.page.width * window.devicePixelRatio;
			this.height = FeditorData.page.height * window.devicePixelRatio;
			el.prop('width', this.width);
			el.prop('height', this.height);
			window.onresize = this.resize;

			this.canvas = new fabric.Canvas(el.attr('id'),{
				preserveObjectStacking:true,
				selectionKey:'ctrlKey',
			});

			//fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';
      		fabric.Text.prototype.originX = 'center';
			fabric.Object.prototype.transparentCorners = false;

			this.createComponent();
			this.bindInput();
			this.reload();
			this.bindAnimate();
		},

		resize:function(){},

		/////// 自定义组件
		createComponent:function(){
			// 文本框
			fabric.TextRect = fabric.util.createClass(fabric.Rect, {
				type: 'TextRect',
				initialize: function(options) {
					options || (options = {});
					options.width = options.width || 100;
					options.height = options.height || 30;
					this.callSuper('initialize', options);
					this.set('text', options.text || '中文A123');
					this.set('textFill', options.textFill || '#000');
				},
				toObject: function() {
					return fabric.util.object.extend(this.callSuper('toObject'), {
						_zid: this.get('_zid'),
						_zbind: this.get('_zbind'),
						text: this.get('text'),
						textFill: this.get('textFill'),
					});
				},
				_render: function(ctx) {
					this.callSuper('_render', ctx);
					ctx.font = (this.height * 0.7) + 'px Helvetica';
					ctx.fillStyle = this.textFill;
					ctx.textAlign="center";
					ctx.textBaseline="middle";
					ctx.fillText(this.text,0, this.height * 0.05);
				}
			});

			fabric.TextRect.fromObject = function(object, callback) {
				return fabric.Object._fromObject('TextRect', object, callback);
			};

			// 管道
			fabric.Pipe = fabric.util.createClass(fabric.Group, {
				type: 'Pipe',
				initialize: function(options) {
					options || (options = {});

					options.pipeBackColor = options.pipeBackColor || '#000';
					options.pipeColor = options.pipeColor || '#0F0';
					options.pipeWidth = options.pipeWidth || 15;
					options.pipeOpacity = options.pipeOpacity || 1;
					options.hasControls = false;
					options.objectCaching = false;

					options.list = options.list || [
						{x:0, y:0},
						{x:200, y:100},
						{x:200, y:200},
					];

					let item1 = new fabric.Polyline(options.list, {
						top:0,
						left:0,
						fill: 'transparent',
						stroke: options.pipeBackColor, 
						strokeWidth: options.pipeWidth,
						strokeLineCap:'round',
						strokeLineJoin:'round',
						objectCaching:false,
					});
					let item2 = new fabric.Polyline(options.list, {
						top:options.pipeWidth * 0.2,
						left:options.pipeWidth * 0.2,
						fill: 'transparent',
						stroke: options.pipeColor, 
						strokeWidth: options.pipeWidth * 0.6,
						strokeLineCap:'round',
						strokeLineJoin:'round',
						strokeDashArray: [options.pipeWidth * 1.2, options.pipeWidth],
						strokeDashOffset: 0,
						opacity:options.pipeOpacity,
						objectCaching:false,
					});

					this.callSuper('initialize', [item1, item2], options);
					this.set('pipeBackColor', options.pipeBackColor);
					this.set('pipeColor', options.pipeColor);
					this.set('pipeWidth', options.pipeWidth);
					this.set('pipeOpacity', options.pipeOpacity);
					this.set('list', options.list);
				},
				toObject: function() {
					return fabric.util.object.extend(this.callSuper('toObject'), {
						_zid: this.get('_zid'),
						_zbind: this.get('_zbind'),
						pipeBackColor: this.get('pipeBackColor'),
						pipeColor: this.get('pipeColor'),
						pipeWidth: this.get('pipeWidth'),
						pipeOpacity: this.get('pipeOpacity'),
						list: this.get('list'),
					});
				},
				_updateAttr() {
					this._objects[0].set({
						stroke: this.pipeBackColor, 
						strokeWidth: this.pipeWidth,
					});
					this._objects[1].set({
						top:this._objects[0].top + this.pipeWidth * 0.2,
						left:this._objects[0].left + this.pipeWidth * 0.2,
						stroke: this.pipeColor, 
						strokeWidth: this.pipeWidth * 0.6,
						strokeDashArray: [this.pipeWidth * 1.2, this.pipeWidth],
						opacity:this.pipeOpacity,
					});
					this._objects[0].setCoords();
					this._objects[1].setCoords();
					this.setCoords();
				},
				_render: function(ctx) {
					console.log(this, ctx);
					this.callSuper('_render', ctx);
				}
			});

			fabric.Pipe.fromObject = function(object, callback) {
				return fabric.Object._fromObject('Pipe', object, callback);
			};
		},

		/////// 绑定编辑值
		bindInput:function(){
			this.canvas.on('selection:created', function(options) {
				if (options.selected.length != 1) return;
				Feditor.bindObj(options.selected[0]);
				if (options.selected[0].type == 'Pipe')
				{
					Feditor.createPipePoint(options.selected[0]);
				}
			});
			this.canvas.on('selection:updated', function(options) {
				if (options.selected.length != 1) return;
				$('.attr-type').hide();
				Feditor.bindObj(options.selected[0]);
				if (options.selected[0].type == 'Pipe')
				{
					Feditor.clearPipePoint();
					Feditor.createPipePoint(options.selected[0]);
				}
			});
			this.canvas.on('selection:cleared', function(options) {
				$('.attr-type').hide();
				Feditor.clearPipePoint();
				console.log(options);
			});
			this.canvas.on('object:moving', function(options) {
				if (!options.target._zid) return;
				Feditor.bindObj(options.target);
				Feditor.pipePointMove(options.target);
			});
			this.canvas.on('object:scaling', function(options) {
				if (!options.target._zid) return;
				Feditor.bindObj(options.target);
			});
			this.canvas.on('object:rotating', function(options) {
				if (!options.target._zid) return;
				Feditor.bindObj(options.target);
			});
			this.canvas.on('object:skewing', function(options) {
				if (!options.target._zid) return;
				Feditor.bindObj(options.target);
			});
			this.canvas.on('object:resizing', function(options) {
				if (!options.target._zid) return;
				Feditor.bindObj(options.target);
			});

			$('#attrPage_width, #attrPage_height').change(function(){
				let w = parseInt($('#attrPage_width').val());
				let h = parseInt($('#attrPage_height').val());
				FeditorData.page.width = w;
				FeditorData.page.height = h;

				Feditor.canvas.setDimensions({
					width: w * window.devicePixelRatio,
					height: h * window.devicePixelRatio,
				});
			});
			$('#attrPage_backgroundColor').change(function(){
				Feditor.canvas.backgroundColor = $(this).val();
				Feditor.canvas.renderAll();
			});
			$('#attrPage_zoom').change(function(){
				FeditorData.page.zoom = $(this).val();
				Feditor.canvas.setZoom($(this).val());
				Feditor.canvas.renderAll();
			});
			$('#divAttrList .attr').change(function(){
				let key = $(this).attr('id').substr(5);

				let obj = Feditor.canvas.getActiveObject();
				if (!obj || obj.type == 'activeSelection') return;

				if ($(this).attr('type') == 'checkbox')
				{
					obj.set(key, this.checked);
				}
				else if (key == 'angle')
				{
					obj.rotate($(this).val());
					Feditor.bindObj(obj);
				}
				else if (typeof(obj[key]) == 'number')
				{
					obj.set(key, parseFloat($(this).val()));
				}
				else
				{
					obj.set(key, $(this).val());
				}

				if (obj._updateAttr)
				{
					obj._updateAttr();
				}
				obj.dirty = true;
				//Feditor.canvas.renderAll();
			});
			$('#divAttrList .attrBind').change(function(){
				let key = $(this).attr('id').substr(9);

				let obj = Feditor.canvas.getActiveObject();
				if (!obj || obj.type == 'activeSelection') return;

				if (!obj._zbind)
				{
					obj._zbind = {};
				}

				obj._zbind[key] = $(this).val();
				console.log(obj);
			});
		},

		attrReset:function(){
			let obj = Feditor.canvas.getActiveObject();
			if (!obj || obj.type == 'activeSelection') return;
			$('#attr_scaleX').val(1);
			$('#attr_scaleY').val(1);
			$('#attr_flipX')[0].checked = false;
			$('#attr_flipY')[0].checked = false;
			$('#attr_skewX').val(0);
			$('#attr_skewY').val(0);
			$('#attr_angle').val(0);
			obj.set({
				scaleX:1,
				scaleY:1,
				flipX:false,
				flipY:false,
				skewX:0,
				skewY:0,
				angle:0,
			});

			Feditor.canvas.renderAll();
		},

		bindObj:function(obj){
			$('.attr-type-' + obj.type).show();
			$('#divAttrList .attr').each(function(){
				let key = $(this).attr('id').substr(5);
			
				if ($(this).attr('type') == 'checkbox')
				{
					this.checked = obj[key];
				}
				else if (typeof(obj[key]) == 'number')
				{
					$(this).val(obj[key].toFixed($(this).data('fix') || 0));
				}
				else
				{
					$(this).val(obj[key]);
				}
			});
			$('#divAttrList .attrBind').each(function(){
				let key = $(this).attr('id').substr(9);
				if (obj._zbind)
				{
					$(this).val(obj._zbind[key]);
				}
				else
				{
					$(this).val('');
				}
			});
		},

		/////// 层级处理
		bringToFront:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.bringToFront();
		},
		bringForward:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.bringForward();
		},
		sendToBack:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.sendToBack();
		},
		sendBackwards:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			obj.sendBackwards();
		},

		toGroup:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj || obj.type != 'activeSelection') return;
			obj.toGroup();
			this.canvas.renderAll();
		},
		splitGroup:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj || obj.type == 'activeSelection') return;
			obj.toActiveSelection();
			this.canvas.renderAll();
		},

		/////// 元素添加

		addItem:function(item, active = true){
			this.canvas.add(item);
			item.set('_zid', FeditorData.elIndex++);
			if (active)
			{
				this.canvas.setActiveObject(item);
			}

			return item;
		},

		addRect:function(){
			let item = new fabric.Rect({
				width: 100, height: 100, left: 50, top: 50,
				fill: '#99F',
				stroke: '#000', strokeWidth: 1,
			});

			item.lockScalingX = true;
			item.lockScalingY = true;

			this.addItem(item);
		},
		
		addCircle:function(){
			let item = new fabric.Circle({
				radius: 50, left: 50, top: 50,
				fill: '#9F9',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addTriangle:function(){
			let item = new fabric.Triangle({
				width: 100, height: 100, left: 50, top: 50,
				fill: '#F99',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},

		addEllipse:function(){
			let item = new fabric.Ellipse({
				rx: 80, ry: 40, left: 50, top: 50,
				fill: '#FF9',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},

		addLine:function(){
			let item = new fabric.Line([10, 10, 100, 100], {
				fill: 'green',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},

		getStarPath:function(num){
			let list = [];
			let bo = true;
			for (let i=0; i<=360; i+=360/num/2)
			{
				bo = !bo;
				let du = i * 0.017453293;
				list.push({
					x: 200 + Math.sin(du) * (bo ? 100 : 40),
					y: 200 + Math.cos(du) * (bo ? 100 : 40),
				});
			}

			return list;
		},
		
		addPolygon:function(num){
			num = num || 5;
			let list = this.getStarPath(num);
			let item = new fabric.Polygon(list, {
				fill: '#9F9',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addPolyline:function(num){
			num = num || 5;
			let list = this.getStarPath(num);
			let item = new fabric.Polyline(list, {
				fill: 'transparent',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},
		
		addRing:function(angle1, angle2, x, y, r1, r2){
			let point1 = {};
			let point2 = {};
			let point3 = {};
			let point4 = {};
			let isBig = 0
			angle1 = angle1 % 360;
			angle2 = angle2 % 360;

			if (angle2 > 180) {
				isBig = 1
			}

			let item = null;
			if (!angle2) {
				point1.x = r1 + x;
				point1.y = y;
				point2.x = r2 + x;
				point2.y = y;
				item = new fabric.Path(`M${point1.x},${point1.y} A${r1},${r1} 0 0,1 ${point1.x - 2 * r1},${point1.y}
				A${r1},${r1} 0 0,1 ${point1.x},${point1.y}
				M${point2.x},${point2.y} A${r2},${r2} 0 0,1 ${point2.x - 2 * r2},${point2.y}
				A${r2},${r2} 0 0,1 ${point2.x},${point2.y}`, {
					stroke: '#000',
					fill: '#F99',
				})
			} else {
				let d1 = angle1 / 180 * Math.PI;
				let d2 = (angle1 + angle2) / 180 * Math.PI;
				point1.x = r1 * Math.cos(d1) + x;
				point1.y = r1 * Math.sin(d1) + y;
				point2.x = r2 * Math.cos(d1) + x;
				point2.y = r2 * Math.sin(d1) + y;
				point3.x = r2 * Math.cos(d2) + x;
				point3.y = r2 * Math.sin(d2) + y;
				point4.x = r1 * Math.cos(d2) + x;
				point4.y = r1 * Math.sin(d2) + y;
				item = new fabric.Path(`M${point1.x},${point1.y} L${point2.x},${point2.y} A${r2},${r2} 0 ${isBig},1 ${point3.x},${point3.y} L${point4.x},${point4.y} A${r1},${r1} 0 ${isBig},0 ${point1.x},${point1.y}`, {
					stroke: '#000',
					fill: '#F99',
					// hasControls: false
				});
			}
			
			this.addItem(item);
		},

		addText:function(str){
			str = str || 'Hello 中国123!';
			let item = new fabric.Text(str, {
				left: 100,
				top: 100,
				strokeWidth:0,
				fontSize: 40,
				fill: 'green',
				textBackgroundColor: 'transparent',
				originX:'left',
				originY:'top',
			});

			this.addItem(item);
		},

		addPath:function(path){
			if (!path)
			{
				path = window.prompt('输入绘图路径：', 'M 0 0 L 300 100 L 200 300 Z');
				if (!path) return;
			}
			let item = new fabric.Path(path);
			item.set({ stroke: 'green', fill:'transparent', left:100, top:100 });
			this.addItem(item);
		},
		
		addTextbox:function(str){
			str = str || 'Hello 中国123!';
			let item = new fabric.Textbox(str, {
				left: 100,
				top: 100,
				strokeWidth:0,
				fontSize: 40,
				fill: 'green',
				textBackgroundColor: 'transparent'
			});

			this.addItem(item);
		},

		addImage:function(url){
			if (!url)
			{
				url = window.prompt('输入图片路径：', '../static/img/img01.png');
				if (!url) return;
			}
			
			fabric.Image.fromURL(url, function(image) {
				image.set({
					left: 100,
					top: 100,
					shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', offsetX: 10, offsetY: 10, blur: 10 })
				});
				image.scale(0.3).setCoords();
				
				Feditor.addItem(image);
			});
		},

		addButton:function(str){
			str = str || 'button';
			let rect = new fabric.Rect({ width: 200, height: 50, fill: '#faa', rx: 10, ry: 10, strokeWidth:0 });
			let text = new fabric.Text(str, { fontSize: 20, left:100, top:25, fontFamily: 'Georgia', strokeWidth:0, textAlign: 'center', originX:'center', originY:'center', });
			let group = new fabric.Group([ rect, text ], { left: 100, top: 100, hasControls: false, hasBorders:false });
			
			this.addItem(group);
			//this.canvas.calcOffset();

			group.on('mouseover', function() {
				rect.fill = '#F00';
				group.dirty = true;
			});
			group.on('mouseout', function() {
				rect.fill = '#FAA';
				group.dirty = true;
			});
		},
		
		addPipe1:function(){
			let list = [
				{x:0, y:0},
				{x:200, y:100},
				{x:200, y:200},
			];

			let item1 = new fabric.Polyline(list, {
				fill: 'transparent',
				stroke: '#0F0', 
				strokeWidth: 10,
				strokeLineCap:'round',
				strokeLineJoin:'round',
				strokeDashArray: [20,15],
				strokeDashOffset: 0,
			});
			let item2 = new fabric.Polyline(list, {
				fill: 'transparent',
				stroke: '#000', 
				strokeWidth: 15,
				strokeLineCap:'round',
				strokeLineJoin:'round',
			});
			
			let group = new fabric.Group([ item2, item1 ], { left: 100, top: 100 });
			group.set('_ztype', 'pipe');
			group.set('_zbind', {
				am1:'flow,1',
			});

			this.addItem(group);
		},
		
		addPipe:function(){
			let item = new fabric.Pipe({
				left: 50, top: 50,
			});

			this.addItem(item);
		},

		addTextRect:function(){
			let item = new fabric.TextRect({
				left: 50, top: 50,
				fill: '#99F',
				stroke: '#000', strokeWidth: 1,
			});

			this.addItem(item);
		},

		/// 操作

		copy:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			if (obj.type != 'activeSelection')
			{
				obj.clone(function(objClone){
					objClone.set({
						top:objClone.top+10,
						left:objClone.left+10,
					});
					
					Feditor.addItem(objClone);
				});
			}
			else
			{
				for (let r of obj._objects)
				{
					r.clone(function(objClone){
						objClone.set({
							top:10+Feditor.canvas._activeObject.top+objClone.top+Feditor.canvas._activeObject.height/2,
							left:10+Feditor.canvas._activeObject.left+objClone.left+Feditor.canvas._activeObject.width/2,
						});

						objClone.set('canvas', Feditor.canvas);
						objClone.setCoords();
						
						Feditor.addItem(objClone, false);
					});
				}
			}
		},

		delete:function(){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;
			if (obj.type != 'activeSelection')
			{
				this.canvas.remove(obj);
			}
			else
			{
				for (let r of obj._objects)
				{
					this.canvas.remove(r);
				}
			}

			this.canvas._activeObject = null;
		},

		deleteAll:function(){
			this.canvas._objects = [];
			this.canvas._activeObject = null;
			this.canvas.renderAll();
		},

		save:function(){
			let json = this.canvas.toJSON(['_zid', '_ztype', '_zbind']);
			let saveData = {
				editor:FeditorData,
				data:json,
			};
			window.localStorage.setItem('Feditor_data', JSON.stringify(saveData));
			alert('保存成功');
		},

		reload:function(){
			let arr = window.localStorage.getItem('Feditor_data');
			if (!arr) return;
			let saveData = JSON.parse(arr);
			FeditorData = saveData.editor;

			this.canvas.setDimensions({
				width: FeditorData.page.width * window.devicePixelRatio,
				height: FeditorData.page.height * window.devicePixelRatio,
			});
			$('#attr_page_width').val(FeditorData.page.width);
			$('#attr_page_height').val(FeditorData.page.height);

			this.canvas.loadFromJSON(saveData.data, function(){
				Feditor.canvas.forEachObject(function(obj){
					if (obj._ztype && obj._ztype.indexOf('temp') === 0)
					{
						Feditor.canvas.remove(obj);
					}
				});
				Feditor.canvas.renderAll();
				$('#attr_page_backgroundColor').val(Feditor.canvas.backgroundColor);
				$('#attr_page_zoom').val(FeditorData.page.zoom);
				Feditor.canvas.setZoom(FeditorData.page.zoom);
			});
		},

		/// 对齐
		align:function(type){
			let obj = this.canvas.getActiveObject();
			if (!obj) return;

			if (type == 'mhcenter')
			{
				//obj.set({left:this.canvas.width / 2 - obj.width / 2});
				obj.centerH();
				obj.setCoords();
				this.canvas.renderAll();
				return;
			}
			if (type == 'mvcenter')
			{
				//obj.set({top:this.canvas.height / 2 - obj.height / 2});
				obj.centerV();
				obj.setCoords();
				this.canvas.renderAll();
				return;
			}

			if (obj.type != 'activeSelection') return;

			if (type == 'mhavg')
			{
				obj._objects.sort((a, b) => {
                	return a.left - b.left;
				});

				let totalW = 0;
				obj._objects.forEach(function(item){
					totalW += item.width * item.scaleX;
				});

				let stepW = (obj.width - totalW) / (obj.size() - 1);
				let leftW = 0;
				for (let i=0; i<obj.size(); i++)
				{
					obj._objects[i].set({left:leftW - obj.width/2});
					leftW += obj._objects[i].width * obj._objects[i].scaleX + stepW;
				}
				this.canvas.renderAll();
				return;
			}
			if (type == 'mvavg')
			{
				obj._objects.sort((a, b) => {
                	return a.top - b.top;
				});

				let totalH = 0;
				obj._objects.forEach(function(item){
					totalH += item.height * item.scaleY;
				});

				let stepH = (obj.height - totalH) / (obj.size() - 1);
				let leftH = 0;
				for (let i=0; i<obj.size(); i++)
				{
					obj._objects[i].set({top:leftH - obj.height/2});
					leftH += obj._objects[i].height * obj._objects[i].scaleY + stepH;
				}
				this.canvas.renderAll();
				return;
			}

			obj._objects.forEach(function(item){
				let w = item.width * item.scaleX;
				let h = item.height * item.scaleY;
				switch(type)
				{
					case 'left':
						item.set({left:0 - obj.width * 0.5})
						break;
					case 'top':
						item.set({top:0 - obj.height * 0.5})
						break;
					case 'right':
						item.set({left:obj.width * 0.5 - w})
						break;
					case 'bottom':
						item.set({top:obj.height * 0.5 - h})
						break;
					case 'vcenter':
						item.set({left:-w/2})
						break;
					case 'hcenter':
						item.set({top:-h/2})
						break;
				}
			});

			this.canvas.renderAll();
		},

		// 动画处理
		amIndex:0,
		bindAnimate:function(){
			setTimeout(function animate() {
				Feditor.amIndex++;
				Feditor.canvas.forEachObject(function(obj){
					if (!obj._zbind) return;
					if (obj._zbind.am1) Feditor.parseAnimate(obj, obj._zbind.am1, Feditor.amIndex);
					if (obj._zbind.am2) Feditor.parseAnimate(obj, obj._zbind.am2, Feditor.amIndex);
					if (obj._zbind.am3) Feditor.parseAnimate(obj, obj._zbind.am3, Feditor.amIndex);
				});
				Feditor.canvas.renderAll();
				setTimeout(animate, 10);
			}, 100);
		},

		parseAnimate:function(obj, am, index){
			let arr = am.split(',');
			let v = 0;
			if (arr.length < 2) return;
			switch (arr[0])
			{
				case 'flow':
					v = parseFloat(arr[1]);
					if (v != 0)
					{
						obj._objects[1].strokeDashOffset = index * v;
						obj.dirty = true; 
					}
					break;
				case 'rotate':
					v = parseFloat(arr[1]);
					if (v != 0)
					{
						obj.rotate((index * v) % 360);
						obj.dirty = true; 
					}
					break;
				case 'blink':
					v = parseFloat(arr[1]) / 100;
					let blinkStep = arr.length > 2 ? parseFloat(arr[2]) : 100;
					if (v != 0)
					{
						obj.set('opacity', index % blinkStep / blinkStep > v ? 1 : 0.1);
						obj.dirty = true; 
					}
					break;
				case 'mHeight':
					v = parseFloat(arr[1]);
					if (v != obj.height)
					{
						let h = this.goVal(v, obj.height);
						obj.set('height', h);
						obj.dirty = true; 
					}
					break;
				case 'mWidth':
					v = parseFloat(arr[1]);
					if (v != obj.width)
					{
						let w = this.goVal(v, obj.width);
						obj.set('width', w);
						obj.dirty = true; 
					}
					break;
				case 'move':
					if (arr.length == 3)
					{
						let x = arr[1] === '' ? obj.left : parseFloat(arr[1]);
						let y = arr[2] === '' ? obj.top : parseFloat(arr[2]);
						if (x != obj.left)
						{
							obj.set('left', this.goVal(x, obj.left));
							obj.dirty = true; 
						}
						if (y != obj.top)
						{
							obj.set('top', this.goVal(y, obj.top));
							obj.dirty = true; 
						}
					}
					break;
			}
		},

		goVal:function(v, cur){
			let val = cur + (v - cur) * 0.02;
			if (Math.abs(v - cur) < 50)
			{
				val = cur + (v > cur ? 1 : -1);
			}
			
			if (Math.abs(v-cur) < 1)
			{
				val = v;
			}

			return val;
		},

		///// Pipe 管道位置编辑
		clearPipePoint:function(){
			for (let r of this.pipePList)
			{
				this.canvas.remove(r);
			}

			this.pipeCur = null;
			this.pipePList = [];
		},

		createPipePoint:function(o){
			let list = o._objects[0].points;
			for (let k in list)
			{
				let r = list[k];
				let item = new fabric.Circle({
					radius: 5, 
					left: o.left + r.x + o.pipeWidth * 0.5, 
					top: o.top + r.y + o.pipeWidth * 0.5, 
					fill: 'rgba(255,0,0,0.9)',
					stroke: '#000', 
					strokeWidth: 0,
					hasControls: false,
					originX:'center',
					originY:'center',
				});

				let kIndex = parseInt(k);
				item._zPipePointIndex = kIndex;
				item._ztype = 'temp_pipe_point';
				this.addItem(item, false);
				this.pipePList.push(item);

				if (k < list.length - 1)
				{
					let x = (r.x + list[kIndex+1].x) / 2;
					let y = (r.y + list[kIndex+1].y) / 2;
					let item2 = new fabric.Circle({
						radius: 5, 
						left: o.left + x + o.pipeWidth * 0.5, 
						top: o.top + y + o.pipeWidth * 0.5, 
						fill: 'rgba(255,0,0,0.5)',
						stroke: '#000', 
						strokeWidth: 0,
						hasControls: false,
						originX:'center',
						originY:'center',
					});

					item2._zPipePointIndex = kIndex + 0.5;
					item2._ztype = 'temp_pipe_point';
					this.addItem(item2, false);
					this.pipePList.push(item2);
				}
			}
			this.pipeCur = o;
		},

		pipePointMove:function(o){
			if (o._ztype != 'temp_pipe_point') return;
			if (this.pipeCur == null) return;

			let x = o.left - this.pipeCur.left - this.pipeCur.pipeWidth * 0.5;
			let y = o.top - this.pipeCur.top - this.pipeCur.pipeWidth * 0.5;

			if (o._zPipePointIndex % 1 != 0)
			{
				// 创建拐点
				this.pipeCur._objects[0].points.splice(o._zPipePointIndex + 0.5, 0, {x:x, y:y});
				console.log(o._zPipePointIndex, this.pipeCur._objects[0].points, x, y);
				let item = this.pipeCur;
				this.clearPipePoint();
				this.createPipePoint(item);
				return;
			}

			this.pipeCur._objects[0].points[o._zPipePointIndex].x = x;
			this.pipeCur._objects[0].points[o._zPipePointIndex].y = y;

			if (o._zPipePointIndex > 0)
			{
				let p1 = this.pipePList[o._zPipePointIndex * 2 - 1];
				let p2 = this.pipePList[o._zPipePointIndex * 2 - 2];
				p1.set({
					left: (o.left + p2.left) / 2, 
					top: (o.top + p2.top) / 2, 
				});
			}
			if (o._zPipePointIndex < this.pipeCur._objects[0].points.length - 1)
			{
				let p1 = this.pipePList[o._zPipePointIndex * 2 + 1];
				let p2 = this.pipePList[o._zPipePointIndex * 2 + 2];
				p1.set({
					left: (o.left + p2.left) / 2, 
					top: (o.top + p2.top) / 2, 
				});
			}
		}
	};

	</script>

</body>
</html>